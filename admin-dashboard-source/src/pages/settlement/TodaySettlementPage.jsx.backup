import React, { useState, useEffect, useCallback, useMemo, useRef } from 'react';
import { Box, Paper, Typography, Grid, useTheme } from '@mui/material';
import { 
  TableFilterAndPagination, 
  TableHeader, 
  BaseTable, 
  TypeTreeView, 
  TableHeightSetting, 
  TableResizeHandle, 
  ColumnVisibilityDialog, 
  PageHeader, 
  PageContainer,
  TableDebugInfo,
  BulkActionBar 
} from '../../components/baseTemplate/components';
import MemberDetailDialog from '../../components/dialogs/MemberDetailDialog';
import { 
  useTableFilterAndPagination, 
  useTableHeader, 
  useTableColumnDrag,
  useTableData,
  useTypeHierarchy,
  useTableIndent,
  useTableHeaderFixed,
  useTableAutoHeight,
  useTableResize,
  useColumnVisibility,
  useTable
} from '../../components/baseTemplate/hooks';
import { useNotification } from '../../contexts/NotificationContext.jsx';
import { 
  todaySettlementColumns,
  apiOptions,
  bankList
} from './data/todaySettlementData';
import useDynamicTypes from '../../hooks/useDynamicTypes';
import usePageData from '../../hooks/usePageData';
import { useSocket } from '../../context/SocketContext';
import { useSnackbar } from '../../hooks/useSnackbar';

/**
 * ë‹¹ì¼ì •ì‚° í˜ì´ì§€
 * ë‹¹ì¼ì •ì‚° ëª©ë¡ ì¡°íšŒ, í•„í„°ë§, í˜ì´ì§€ë„¤ì´ì…˜ ë“±ì˜ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.
 */
const TodaySettlementPage = () => {
  const theme = useTheme();

  // ì „ì—­ ì•Œë¦¼ ì‚¬ìš©
  const { handleRefresh } = useNotification();
  
  // Socket ì„œë¹„ìŠ¤ ì‚¬ìš©
  const { socketService, agentLevelService } = useSocket();

  // ë™ì  ìœ í˜• ê´€ë¦¬
  const {
    types,
    typeHierarchy,
    isLoading: typesLoading,
    error: typesError,
    isInitialized: typesInitialized
  } = useDynamicTypes();
  
  // ë²”ìš© í˜ì´ì§€ ë°ì´í„° í›… ì‚¬ìš© (1ë‹¨ê³„ êµ¬ì¡°)
  const {
    data,
    types: pageDataTypes, // ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
    typeHierarchy: pageDataTypeHierarchy, // ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
    isLoading,
    error,
    refreshPageData
  } = usePageData({
    pageType: 'settlement',
    requiresMembersData: false
  });
  
  // ì‹¤ì œ ì‚¬ìš©í•  ë°ì´í„°
  const actualData = data;
  
  // ë””ë²„ê¹…: ë°ì´í„° í™•ì¸ - buildHierarchicalDataRecursive ì •ì˜ í›„ë¡œ ì´ë™ í•„ìš”
  
  // Socket ì´ë²¤íŠ¸ë¡œ agent-levels ë³€ê²½ ê°ì§€
  const refreshPageDataRef = useRef(refreshPageData);
  refreshPageDataRef.current = refreshPageData;
  
  // AgentLevelServiceì˜ ë³€ê²½ì‚¬í•­ ê°ì§€
  useEffect(() => {
    if (!agentLevelService) return;
    
    const listenerId = agentLevelService.addListener((event) => {
      console.log('ë‹¹ì¼ì •ì‚°: AgentLevelService ì´ë²¤íŠ¸ ìˆ˜ì‹ :', event.type);
      
      if (event.type === 'hierarchy-changed' || event.type === 'updated' || event.type === 'loaded') {
        console.log('ë‹¹ì¼ì •ì‚°: ê³„ì¸µ ë³€ê²½ ê°ì§€, ë°ì´í„° ìƒˆë¡œê³ ì¹¨');
        // ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ê³  ìƒˆë¡œê³ ì¹¨ (DB ì—…ë°ì´íŠ¸ ì™„ë£Œ ëŒ€ê¸°)
        setTimeout(() => {
          if (refreshPageDataRef.current) {
            refreshPageDataRef.current();
          }
        }, 500);
      }
    });
    
    return () => {
      agentLevelService.removeListener(listenerId);
    };
  }, [agentLevelService]);
  
  // í…Œì´ë¸” ë†’ì´ ìë™ ì¡°ì • - useTableAutoHeight í›… ì‚¬ìš©
  const {
    containerRef,
    tableHeight,
    autoHeight,
    toggleAutoHeight,
    setManualHeight
  } = useTableAutoHeight({
    defaultHeight: '500px',
    defaultAutoHeight: true,
    minHeight: 300,
    bottomMargin: 100
  });

  // í…Œì´ë¸” ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥ - useTableResize í›… ì‚¬ìš©
  const {
    isDragging,
    getResizeHandleProps,
    calculateMaxHeight
  } = useTableResize({
    minHeight: 200,
    maxHeight: null,
    useViewportLimit: true,
    viewportMargin: 50,
    onResize: (newHeight) => {
      if (autoHeight) {
        toggleAutoHeight(false);
      }
      setManualHeight(`${newHeight}px`);
    }
  });

  // ë“¤ì—¬ì“°ê¸° ëª¨ë“œ - useTableIndent í›… ì‚¬ìš© (ì •ì‚° í˜ì´ì§€ì—ì„œëŠ” ë¹„í™œì„±í™”)
  const { indentMode, toggleIndentMode } = useTableIndent(true);

  // parentId ê¸°ë°˜ ê³„ì¸µ êµ¬ì¡° ìƒì„± (levelOrder ìˆœì„œ ìœ ì§€)
  const buildHierarchicalDataRecursive = useCallback((items, parentId = null, level = 0) => {
    // parentIdê°€ null, 0, undefinedì¸ ê²½ìš° ëª¨ë‘ ìµœìƒìœ„ë¡œ ì²˜ë¦¬
    const children = items.filter(item => {
      if (parentId === null) {
        return item.parentId === null || item.parentId === 0 || item.parentId === undefined;
      }
      return item.parentId === parentId;
    });
    
    // levelOrderë¡œ ì •ë ¬í•˜ì—¬ ìˆœì„œ ìœ ì§€
    children.sort((a, b) => {
      const aOrder = a.levelOrder || a.level_order || a.agent_level_order || 999;
      const bOrder = b.levelOrder || b.level_order || b.agent_level_order || 999;
      return aOrder - bOrder;
    });
    
    return children.map(item => ({
      ...item,
      level: level,  // ë ˆë²¨ ì •ë³´ ì¶”ê°€
      _displayLevel: level,  // TableBodyê°€ ì‚¬ìš©í•˜ëŠ” ë ˆë²¨ ì •ë³´
      children: buildHierarchicalDataRecursive(items, item.id, level + 1)
    })).filter(item => item.id !== undefined);
  }, []);
  
  // ê³„ì¸µì  ë°ì´í„°ë¥¼ í‰íƒ„í™”í•˜ì—¬ í‘œì‹œìš© ë°ì´í„° ìƒì„± (íšŒì›ê´€ë¦¬ì™€ ë™ì¼í•œ ë°©ì‹)
  const flattenHierarchicalData = useCallback((items) => {
    const result = [];
    const flatten = (items) => {
      items.forEach(item => {
        result.push(item);
        if (item.children && item.children.length > 0) {
          flatten(item.children);
        }
      });
    };
    flatten(items);
    return result;
  }, []);

  // ê³„ì¸µ ë°ì´í„° ìƒì„± (íšŒì›ê´€ë¦¬ì™€ ë™ì¼)
  const hierarchicalData = useMemo(() => {
    console.log('ğŸ—ï¸ ë‹¹ì¼ì •ì‚° ê³„ì¸µ ë°ì´í„° ìƒì„±, ì›ë³¸ ë°ì´í„°:', data?.length || 0, 'ê°œ');
    
    if (!data || data.length === 0) return [];
    
    // levelOrderë¡œ ë¨¼ì € ì •ë ¬í•˜ì—¬ ë‹¨ê³„ì„¤ì • ìˆœì„œ ë°˜ì˜
    const sortedData = [...data].sort((a, b) => {
      const aOrder = a.levelOrder || a.level_order || a.agent_level_order || 999;
      const bOrder = b.levelOrder || b.level_order || b.agent_level_order || 999;
      if (aOrder !== bOrder) return aOrder - bOrder;
      return a.id - b.id;
    });
    
    const result = buildHierarchicalDataRecursive(sortedData);
    console.log('ğŸ—ï¸ ë‹¹ì¼ì •ì‚° ê³„ì¸µ êµ¬ì¡° ê²°ê³¼:', result.length, 'ê°œ ìµœìƒìœ„ í•­ëª©');
    return result;
  }, [data, buildHierarchicalDataRecursive]);
  
  // í¼ì³ì§„ í•­ëª© ì¶”ì  - ì´ˆê¸°ê°’ì„ í•¨ìˆ˜ë¡œ ì„¤ì • (íšŒì›ê´€ë¦¬ì™€ ë™ì¼)
  const [expandedItems, setExpandedItems] = useState(() => {
    // ì´ˆê¸°ì— ëª¨ë“  í•­ëª©ì„ í¼ì¹œ ìƒíƒœë¡œ ì„¤ì •
    const initialExpanded = {};
    const addAllItems = (items) => {
      items.forEach(item => {
        if (item.children && item.children.length > 0) {
          initialExpanded[item.id] = true;
          addAllItems(item.children);
        }
      });
    };
    if (hierarchicalData.length > 0) {
      addAllItems(hierarchicalData);
    }
    return initialExpanded;
  });
  
  // í•­ëª© í¼ì¹˜ê¸°/ì ‘ê¸° í† ê¸€
  const toggleTypeExpand = useCallback((itemId) => {
    setExpandedItems(prev => ({
      ...prev,
      [itemId]: !prev[itemId]
    }));
  }, []);
  
  // ëª¨ë“  í•­ëª© í¼ì¹˜ê¸°
  const setAllExpanded = useCallback((expanded) => {
    const newExpanded = {};
    const addAllItems = (items) => {
      items.forEach(item => {
        if (item.children && item.children.length > 0) {
          newExpanded[item.id] = expanded;
          addAllItems(item.children);
        }
      });
    };
    addAllItems(hierarchicalData);
    setExpandedItems(newExpanded);
  }, [hierarchicalData]);
  
  // hierarchicalDataê°€ ë³€ê²½ë  ë•Œ ëª¨ë“  í•­ëª© í¼ì¹˜ê¸° (íšŒì›ê´€ë¦¬ì™€ ë™ì¼)
  useEffect(() => {
    // ë°ì´í„°ê°€ ì²˜ìŒ ë¡œë“œë  ë•Œë§Œ ì´ˆê¸° í™•ì¥ ìƒíƒœ ì„¤ì •
    if (hierarchicalData.length > 0 && Object.keys(expandedItems).length === 0) {
      const newExpanded = {};
      const addAllItems = (items) => {
        items.forEach(item => {
          if (item.children && item.children.length > 0) {
            newExpanded[item.id] = true;
            addAllItems(item.children);
          }
        });
      };
      addAllItems(hierarchicalData);
      setExpandedItems(newExpanded);
    }
  }, [hierarchicalData.length]); // ì˜ì¡´ì„±ì„ ê¸¸ì´ë¡œë§Œ í™•ì¸
  
  // í‰íƒ„í™”ëœ ë°ì´í„° (íšŒì›ê´€ë¦¬ì™€ ë™ì¼)
  const flattenedData = useMemo(() => {
    return flattenHierarchicalData(hierarchicalData);
  }, [hierarchicalData, flattenHierarchicalData]);
  
  // í—¤ë” í–‰ ê³ ì • ê¸°ëŠ¥ - useTableHeaderFixed í›… ì‚¬ìš©
  const {
    tableHeaderRef,
    getTableHeaderStyles
  } = useTableHeaderFixed({
    zIndex: 10,
    boxShadow: '0 2px 5px rgba(0, 0, 0, 0.1)'
  });

  // íšŒì›ìƒì„¸ì •ë³´ ë‹¤ì´ì–¼ë¡œê·¸ ìƒíƒœ
  const [memberDetailDialogOpen, setMemberDetailDialogOpen] = useState(false);
  const [selectedMemberForDetail, setSelectedMemberForDetail] = useState(null);

  // íšŒì›ìƒì„¸ì •ë³´ ë‹¤ì´ì–¼ë¡œê·¸ í•¸ë“¤ëŸ¬ë“¤
  const handleMemberDetailOpen = useCallback((member) => {
    setSelectedMemberForDetail(member);
    setMemberDetailDialogOpen(true);
  }, []);

  const handleMemberDetailClose = useCallback(() => {
    setMemberDetailDialogOpen(false);
    setSelectedMemberForDetail(null);
  }, []);

  const handleMemberDetailSave = useCallback((updatedMember) => {
    alert(`${updatedMember.nickname || updatedMember.username}ë‹˜ì˜ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    handleMemberDetailClose();
  }, [handleMemberDetailClose]);

  // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ í•¸ë“¤ëŸ¬
  const handleExcelDownload = useCallback(() => {
    alert('ë‹¹ì¼ì •ì‚° ëª©ë¡ì„ ì—‘ì…€ë¡œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.');
  }, []);

  // ì¸ì‡„ í•¸ë“¤ëŸ¬
  const handlePrint = useCallback(() => {
    alert('ë‹¹ì¼ì •ì‚° ëª©ë¡ì„ ì¸ì‡„í•©ë‹ˆë‹¤.');
  }, []);

  // ì»¬ëŸ¼ì— ì•¡ì…˜ ì¶”ê°€ (íšŒì›ê´€ë¦¬ì™€ ë™ì¼)
  const columnsWithActions = useMemo(() => {
    return todaySettlementColumns.map(column => {
      if (column.field === 'type') {
        return {
          ...column,
          renderCell: (params) => {
            const { row } = params;
            const hasChildren = row.children && row.children.length > 0;
            const isExpanded = expandedItems[row.id] !== false;
            const level = row._displayLevel || 0;
            
            return (
              <Box
                sx={{
                  display: 'flex',
                  alignItems: 'center',
                  paddingLeft: `${level * 20}px`,
                  minHeight: '40px'
                }}
              >
                {hasChildren && (
                  <Box
                    onClick={() => toggleTypeExpand(row.id)}
                    sx={{
                      cursor: 'pointer',
                      marginRight: '8px',
                      display: 'flex',
                      alignItems: 'center',
                      fontSize: '12px',
                      color: 'primary.main',
                      '&:hover': {
                        backgroundColor: 'action.hover',
                        borderRadius: '4px'
                      },
                      padding: '2px 4px'
                    }}
                  >
                    {isExpanded ? 'â–¼' : 'â–¶'}
                  </Box>
                )}
                <Typography
                  variant="body2"
                  sx={{
                    fontWeight: hasChildren ? 'bold' : 'normal',
                    color: hasChildren ? 'primary.main' : 'text.primary'
                  }}
                >
                  {row.type || 'ë¯¸ë¶„ë¥˜'}
                </Typography>
              </Box>
            );
          }
        };
      }
      return column;
    });
  }, [expandedItems, toggleTypeExpand]);

  // ë™ì  í•„í„° ì˜µì…˜ ìƒì„±
  const dynamicFilterOptions = useMemo(() => {
    const baseOptions = [
      {
        id: 'status',
        label: 'ìƒíƒœ',
        items: [
          { value: '', label: 'ì „ì²´' },
          { value: 'online', label: 'ì˜¨ë¼ì¸' },
          { value: 'offline', label: 'ì˜¤í”„ë¼ì¸' },
          { value: 'suspended', label: 'ì •ì§€' }
        ]
      },
      {
        id: 'type',
        label: 'íšŒì›ìœ í˜•',
        items: [
          { value: '', label: 'ì „ì²´' },
          ...(typesInitialized && types ? Object.keys(types).map(typeId => ({
            value: typeId,
            label: types[typeId].label || typeId
          })) : [])
        ]
      },
      {
        id: 'api',
        label: 'API',
        items: [
          { value: '', label: 'ì „ì²´' },
          ...apiOptions.map(option => ({
            value: option.value,
            label: option.label
          }))
        ]
      }
    ];
    
    return baseOptions;
  }, [typesInitialized, types, apiOptions]);

  // TableHeader í›… ì‚¬ìš©
  const {
    searchText,
    totalItems,
    sequentialPageNumbers,
    hasPinnedColumns,
    isGridReady,
    handleSearchChange,
    handleClearSearch,
    togglePageNumberMode,
    toggleColumnPin: headerToggleColumnPin,
    setGridReady
  } = useTableHeader({
    initialTotalItems: actualData.length,
    tableId: 'todaySettlementPage',
    onSearch: (value) => {
      console.log(`ë‹¹ì¼ì •ì‚° ê²€ìƒ‰: ${value}`);
    },
    onToggleColumnPin: (hasPinned) => {
      console.log(`ì»¬ëŸ¼ ê³ ì • í† ê¸€: ${hasPinned}`);
      if (hasPinned) {
        setDefaultPinnedColumns();
      } else {
        clearAllPinnedColumns();
      }
    }
  });

  // ê·¸ë¦¬ë“œ ì¤€ë¹„ ìƒíƒœë¡œ ì„¤ì •
  useEffect(() => {
    setGridReady(true);
  }, [setGridReady]);

  // ì»¬ëŸ¼ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê´€ë ¨ í›… ì‚¬ìš©
  const {
    columns,
    dragInfo,
    pinnedColumns,
    handleDragStart,
    handleDragEnd,
    handleDragOver,
    handleDrop,
    updateColumns,
    isColumnPinned,
    toggleColumnPin,
    clearAllPinnedColumns,
    setDefaultPinnedColumns
  } = useTableColumnDrag({
    initialColumns: columnsWithActions,
    tableId: 'today_settlement_table',
    initialPinnedColumns: ['checkbox', 'number', 'type', 'userId'],
    onColumnOrderChange: (newColumns) => {
      console.log('ë‹¹ì¼ì •ì‚° í…Œì´ë¸” ì»¬ëŸ¼ ìˆœì„œ ë³€ê²½:', newColumns);
    }
  });

  // ì»¬ëŸ¼ í‘œì‹œì˜µì…˜ ê´€ë ¨ í›… ì‚¬ìš©
  const {
    columnVisibility,
    visibleColumns,
    hiddenColumnsCount,
    toggleableColumns,
    toggleColumnVisibility,
    showAllColumns,
    resetToDefault
  } = useColumnVisibility(columns, {
    defaultHiddenColumns: [],
    alwaysVisibleColumns: ['checkbox'],
    tableId: 'today_settlement_table'
  });

  // í‘œì‹œì˜µì…˜ ë‹¤ì´ì–¼ë¡œê·¸ ìƒíƒœ
  const [displayOptionsAnchor, setDisplayOptionsAnchor] = useState(null);
  const isDisplayOptionsOpen = Boolean(displayOptionsAnchor);

  // í‘œì‹œì˜µì…˜ ë‹¤ì´ì–¼ë¡œê·¸ í•¸ë“¤ëŸ¬ë“¤
  const handleDisplayOptionsClick = useCallback((event) => {
    const anchorElement = event?.currentTarget || event?.target;
    setDisplayOptionsAnchor(anchorElement);
  }, []);

  const handleDisplayOptionsClose = useCallback(() => {
    setDisplayOptionsAnchor(null);
  }, []);

  // ë“œë˜ê·¸ ì•¤ ë“œë¡­ í™œì„±í™”
  const draggableColumns = true;

  // ë“œë˜ê·¸ ê´€ë ¨ í•¸ë“¤ëŸ¬ ëª¨ìŒ
  const dragHandlers = {
    handleDragStart,
    handleDragEnd,
    handleDragOver,
    handleDrop
  };

  // í–‰ í´ë¦­ í•¸ë“¤ëŸ¬
  const handleRowClick = (row) => {
    console.log('ë‹¹ì¼ì •ì‚° í–‰ í´ë¦­:', row);
  };

  // ê³„ì¸µ í¼ì¹˜ê¸°/ì ‘ê¸° í•¸ë“¤ëŸ¬ëŠ” useTable í›… ì •ì˜ ì´í›„ë¡œ ì´ë™

  // í•„í„° ì½œë°± í•¨ìˆ˜
  const filterCallback = useCallback((result, filterId, filterValue) => {
    switch (filterId) {
      case 'status':
        if (filterValue === 'all' || filterValue === '') return result;
        
        return result.filter(item => {
          switch (filterValue) {
            case 'online':
              return item.connectionStatus === 'ì˜¨ë¼ì¸';
            case 'offline':
              return item.connectionStatus === 'ì˜¤í”„ë¼ì¸';
            case 'suspended':
              return item.connectionStatus === 'ì •ì§€';
            default:
              return true;
          }
        });
        
      case 'type':
        if (filterValue === 'all' || filterValue === '') return result;
        
        return result.filter(item => 
          item.type && item.type.id === filterValue
        );
        
      case 'api':
        if (filterValue === 'all' || filterValue === '') return result;
        
        return result.filter(item => item.api === filterValue);
        
      case 'date':
        let dateFilteredResult = [...result];
        
        if (filterValue.startDate) {
          dateFilteredResult = dateFilteredResult.filter(item => item.id >= 3);
        }
        
        if (filterValue.endDate) {
          dateFilteredResult = dateFilteredResult.filter(item => item.id <= 6);
        }
        
        return dateFilteredResult;
      default:
        return result;
    }
  }, []);
  
  // useTableFilterAndPagination í›…ì€ flattenedData ì •ì˜ ì´í›„ë¡œ ì´ë™

  // ì»¬ëŸ¼ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê´€ë ¨ í›… ì‚¬ìš©
  const {
    columns,
    dragInfo,
    pinnedColumns,
    handleDragStart,
    handleDragEnd,
    handleDragOver,
    handleDrop,
    updateColumns,
    isColumnPinned,
    toggleColumnPin,
    clearAllPinnedColumns,
    setDefaultPinnedColumns
  } = useTableColumnDrag({
    initialColumns: columnsWithActions,
    tableId: 'today_settlement_table',
    initialPinnedColumns: ['checkbox', 'number', 'type', 'userId'],
    onColumnOrderChange: (newColumns) => {
      console.log('ë‹¹ì¼ì •ì‚° í…Œì´ë¸” ì»¬ëŸ¼ ìˆœì„œ ë³€ê²½:', newColumns);
    }
  });

  // ì»¬ëŸ¼ í‘œì‹œì˜µì…˜ ê´€ë ¨ í›… ì‚¬ìš©
  const {
    columnVisibility,
    visibleColumns,
    hiddenColumnsCount,
    toggleableColumns,
    toggleColumnVisibility,
    showAllColumns,
    resetToDefault
  } = useColumnVisibility(columns, {
    defaultHiddenColumns: [],
    alwaysVisibleColumns: ['checkbox'],
    tableId: 'today_settlement_table'
  });

  // í‘œì‹œì˜µì…˜ ë‹¤ì´ì–¼ë¡œê·¸ ìƒíƒœ
  const [displayOptionsAnchor, setDisplayOptionsAnchor] = useState(null);
  const isDisplayOptionsOpen = Boolean(displayOptionsAnchor);

  // í‘œì‹œì˜µì…˜ ë‹¤ì´ì–¼ë¡œê·¸ í•¸ë“¤ëŸ¬ë“¤
  const handleDisplayOptionsClick = useCallback((event) => {
    const anchorElement = event?.currentTarget || event?.target;
    setDisplayOptionsAnchor(anchorElement);
  }, []);

  const handleDisplayOptionsClose = useCallback(() => {
    setDisplayOptionsAnchor(null);
  }, []);

  // ë“œë˜ê·¸ ì•¤ ë“œë¡­ í™œì„±í™”
  const draggableColumns = true;

  // ë“œë˜ê·¸ ê´€ë ¨ í•¸ë“¤ëŸ¬ ëª¨ìŒ
  const dragHandlers = {
    handleDragStart,
    handleDragEnd,
    handleDragOver,
    handleDrop
  };

  // í–‰ í´ë¦­ í•¸ë“¤ëŸ¬
  const handleRowClick = (row) => {
    console.log('ë‹¹ì¼ì •ì‚° í–‰ í´ë¦­:', row);
  };

  // ê³„ì¸µ í¼ì¹˜ê¸°/ì ‘ê¸° í•¸ë“¤ëŸ¬ - useTable í›… ì •ì˜ ì´í›„ì— ë°°ì¹˜
  const handleToggleExpand2 = useCallback((id) => {
    console.log(`ë‹¹ì¼ì •ì‚° ìœ í˜• í† ê¸€: ${id}`);
    toggleTypeExpand(id);
    
    if (typeof tableHandleToggleExpand === 'function') {
      tableHandleToggleExpand(id);
    }
  }, [toggleTypeExpand, tableHandleToggleExpand]);

  // ì´ í‰ë©´í™”ëœ í•­ëª© ìˆ˜ ê³„ì‚° (íšŒì›ê´€ë¦¬ì™€ ë™ì¼)
  const totalFlattenedItems = useMemo(() => {
    return flattenedData.length;
  }, [flattenedData]);

  // í˜„ì¬ í˜ì´ì§€ì™€ rowsPerPageë¥¼ í™œìš©í•˜ëŠ” ë©”ëª¨ì´ì œì´ì…˜ëœ í‘œì‹œ ë°ì´í„° (íšŒì›ê´€ë¦¬ì™€ ë™ì¼)
  const visibleData = useMemo(() => {
    if (!safeFilteredData || safeFilteredData.length === 0) return [];
    
    return safeFilteredData;
  }, [safeFilteredData, page, rowsPerPage, totalFlattenedItems]);

  // visibleColumnsì— ë²„íŠ¼ í•¸ë“¤ëŸ¬ ë‹¤ì‹œ ì¶”ê°€
  const finalColumns = useMemo(() => {
    return visibleColumns.map(column => {
      // userId ì»¬ëŸ¼ì— í´ë¦­ í•¸ë“¤ëŸ¬ ì¶”ê°€
      if (column.id === 'userId') {
        return {
          ...column,
          clickable: true,
          onClick: (row) => {
            console.log('ì•„ì´ë”” í´ë¦­:', row);
            handleMemberDetailOpen(row);
          }
        };
      }
      
      return column;
    });
  }, [visibleColumns, handleMemberDetailOpen]);

  // ë‹¹ì¼ì •ì‚° ê·¸ë£¹ë³„ ìƒ‰ìƒ ìŠ¤íƒ€ì¼
  const settlementGroupStyles = `
    /* ì…ì¶œ ê·¸ë£¹ - íŒŒë€ìƒ‰ ê³„ì—´ */
    [data-column-id="deposit_withdrawal"],
    [data-column-id*="deposit_withdrawal."] {
      background-color: rgba(54, 153, 255, 0.15) !important;
    }
    
    /* ìŠ¬ë¡¯ ê·¸ë£¹ - ì´ˆë¡ìƒ‰ ê³„ì—´ */
    [data-column-id="slot"],
    [data-column-id*="slot."] {
      background-color: rgba(76, 175, 80, 0.15) !important;
    }
    
    /* ì¹´ì§€ë…¸ ê·¸ë£¹ - ë³´ë¼ìƒ‰ ê³„ì—´ */
    [data-column-id="casino"],
    [data-column-id*="casino."] {
      background-color: rgba(156, 39, 176, 0.15) !important;
    }
    
    /* í•©ê³„ ê·¸ë£¹ - ì£¼í™©ìƒ‰ ê³„ì—´ */
    [data-column-id="total"],
    [data-column-id*="total."] {
      background-color: rgba(255, 152, 0, 0.15) !important;
    }
    
    /* í…Œì´ë¸” ë°”ë””ì˜ ì…€ì—ë„ ë™ì¼í•œ ìƒ‰ìƒ ì ìš© - ëª¨ë“  ê°€ëŠ¥í•œ ì„ íƒì */
    .MuiTableBody-root .MuiTableCell-root[data-column-id="deposit_withdrawal"],
    .MuiTableBody-root .MuiTableCell-root[data-column-id*="deposit_withdrawal."],
    tbody .MuiTableCell-root[data-column-id="deposit_withdrawal"],
    tbody .MuiTableCell-root[data-column-id*="deposit_withdrawal."],
    table tbody tr td[data-column-id="deposit_withdrawal"],
    table tbody tr td[data-column-id*="deposit_withdrawal."],
    td[data-column-id="deposit_withdrawal"],
    td[data-column-id*="deposit_withdrawal."] {
      background-color: rgba(54, 153, 255, 0.08) !important;
    }
    
    .MuiTableBody-root .MuiTableCell-root[data-column-id="slot"],
    .MuiTableBody-root .MuiTableCell-root[data-column-id*="slot."],
    tbody .MuiTableCell-root[data-column-id="slot"],
    tbody .MuiTableCell-root[data-column-id*="slot."],
    table tbody tr td[data-column-id="slot"],
    table tbody tr td[data-column-id*="slot."],
    td[data-column-id="slot"],
    td[data-column-id*="slot."] {
      background-color: rgba(76, 175, 80, 0.08) !important;
    }
    
    .MuiTableBody-root .MuiTableCell-root[data-column-id="casino"],
    .MuiTableBody-root .MuiTableCell-root[data-column-id*="casino."],
    tbody .MuiTableCell-root[data-column-id="casino"],
    tbody .MuiTableCell-root[data-column-id*="casino."],
    table tbody tr td[data-column-id="casino"],
    table tbody tr td[data-column-id*="casino."],
    td[data-column-id="casino"],
    td[data-column-id*="casino."] {
      background-color: rgba(156, 39, 176, 0.08) !important;
    }
    
    .MuiTableBody-root .MuiTableCell-root[data-column-id="total"],
    .MuiTableBody-root .MuiTableCell-root[data-column-id*="total."],
    tbody .MuiTableCell-root[data-column-id="total"],
    tbody .MuiTableCell-root[data-column-id*="total."],
    table tbody tr td[data-column-id="total"],
    table tbody tr td[data-column-id*="total."],
    td[data-column-id="total"],
    td[data-column-id*="total."] {
      background-color: rgba(255, 152, 0, 0.08) !important;
    }
  `;

  // ë¡œë”© ì¤‘ì´ê±°ë‚˜ ì—ëŸ¬ê°€ ìˆëŠ” ê²½ìš° ì²˜ë¦¬ - íšŒì›ê´€ë¦¬ì²˜ëŸ¼ ì œê±°
  // ë°ì´í„°ê°€ ì—†ì–´ë„ UIëŠ” í‘œì‹œí•˜ë„ë¡ ë³€ê²½

  return (
    <PageContainer>
      {/* ë‹¹ì¼ì •ì‚° ê·¸ë£¹ë³„ ìƒ‰ìƒ ìŠ¤íƒ€ì¼ ì ìš© */}
      <style>{settlementGroupStyles}</style>
      
      {/* í˜ì´ì§€ í—¤ë” */}
      <PageHeader
        title="ë‹¹ì¼ì •ì‚°"
        onDisplayOptionsClick={handleDisplayOptionsClick}
        showAddButton={false}
        showRefreshButton={true}
        onRefreshClick={async () => {
          console.log('ë‹¹ì¼ì •ì‚°: ë°ì´í„° ìƒˆë¡œê³ ì¹¨');
          handleRefresh('ë‹¹ì¼ì •ì‚° ëª©ë¡');
          
          // usePageDataì˜ refetch í•¨ìˆ˜ í˜¸ì¶œ
          if (refreshPageData) {
            await refreshPageData();
          }
        }}
        sx={{ mb: 2 }}
      />

      {/* ì»¬ëŸ¼ í‘œì‹œì˜µì…˜ ë‹¤ì´ì–¼ë¡œê·¸ */}
      <ColumnVisibilityDialog
        anchorEl={displayOptionsAnchor}
        open={isDisplayOptionsOpen}
        onClose={handleDisplayOptionsClose}
        toggleableColumns={toggleableColumns}
        columnVisibility={columnVisibility}
        onToggleColumn={toggleColumnVisibility}
        onShowAll={showAllColumns}
        onReset={resetToDefault}
        hiddenColumnsCount={hiddenColumnsCount}
        menuWidth="350px"
      />

      <Paper elevation={1} sx={{ p: 3, borderRadius: 2, mb: 3 }}>

        {/* í…Œì´ë¸” í—¤ë” ì»´í¬ë„ŒíŠ¸ */}
        <TableHeader
          title="ë‹¹ì¼ì •ì‚° ëª©ë¡"
          totalItems={totalFlattenedItems}
          countLabel="ì´ ##count##ê±´ì˜ ì •ì‚°"
          indentMode={indentMode}
          toggleIndentMode={toggleIndentMode}
          sequentialPageNumbers={sequentialPageNumbers}
          togglePageNumberMode={togglePageNumberMode}
          hasPinnedColumns={hasPinnedColumns}
          isGridReady={isGridReady}
          toggleColumnPin={headerToggleColumnPin}
          searchText={searchText}
          handleSearchChange={handleSearchChange}
          handleClearSearch={handleClearSearch}
          showIndentToggle={true}
          showPageNumberToggle={true}
          showColumnPinToggle={true}
          showSearch={true}
          searchPlaceholder="ë‹¹ì¼ì •ì‚° ê²€ìƒ‰..."
          sx={{ mb: 2 }}
        />

        <Box sx={{ width: '100%' }}>
          <TableFilterAndPagination
            filterProps={{
              columns: columns,
              filterValues: filterValues || {},
              activeFilters: safeActiveFilters || {},
              filterOptions: dynamicFilterOptions,
              handleFilterChange: manualHandleFilterChange,
              onFilter: handleFilter,
              onClearFilters: handleClearFilters,
              isDateFilterActive: isDateFilterActive,
              handleOpenDateFilter: handleOpenDateFilter,
              resetDateFilter: resetDateFilter
            }}
            paginationProps={{
              count: totalFlattenedItems,
              page: page,
              rowsPerPage: rowsPerPage,
              onPageChange: handlePageChangeWithLog,
              onRowsPerPageChange: handleRowsPerPageChangeWithLog,
              totalCount: totalFlattenedItems,
              onExcelDownload: handleExcelDownload,
              onPrint: handlePrint
            }}
          />
        </Box>
        
        {/* í…Œì´ë¸” ì½˜í…ì¸  ì˜ì—­ */}
        <Box 
          sx={{ 
            width: '100%', 
            mt: 2
          }} 
          ref={containerRef}
        >
          <Typography variant="body2" sx={{ mb: 1, color: 'text.secondary' }}>
            í˜„ì¬ í˜ì´ì§€: {currentPage + 1} / {Math.ceil(totalFlattenedItems / currentRowsPerPage)} (í˜ì´ì§€ë‹¹ {currentRowsPerPage}í–‰)
            {' - ì»¬ëŸ¼ì„ ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œë¥¼ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'}
          </Typography>
          {console.log('ğŸ” BaseTableì— ì „ë‹¬ë˜ëŠ” ë°ì´í„°:', {
            visibleDataLength: visibleData?.length || 0,
            columnsLength: finalColumns?.length || 0,
            page: currentPage,
            rowsPerPage: currentRowsPerPage
          })}
          <BaseTable
            key={`today-settlement-table-${tableKey}`}
            columns={finalColumns}
            data={visibleData}
            checkable={true}
            hierarchical={true}
            indentMode={indentMode}
            checkedItems={tableCheckedItems}
            expandedRows={expandedItems}
            allChecked={tableAllChecked}
            onCheck={tableHandleCheck}
            onToggleAll={tableHandleToggleAll}
            onToggleExpand={handleToggleExpand2}
            onSort={tableHandleSort}
            sortConfig={tableSortConfig}
            page={currentPage}
            rowsPerPage={currentRowsPerPage}
            totalCount={totalFlattenedItems}
            sequentialPageNumbers={sequentialPageNumbers}
            draggableColumns={draggableColumns}
            onColumnOrderChange={updateColumns}
            dragHandlers={dragHandlers}
            dragInfo={dragInfo}
            fixedHeader={true}
            maxHeight={tableHeight}
            tableHeaderRef={tableHeaderRef}
            headerStyle={getTableHeaderStyles()}
            pinnedColumns={pinnedColumns}
          />
          
          {/* í…Œì´ë¸” ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ */}
          <TableResizeHandle 
            resizeHandleProps={getResizeHandleProps(parseFloat(tableHeight))}
            showIcon={true}
            isDragging={isDragging}
            sx={{ 
              mt: 1,
              opacity: isDragging ? 1 : 0.7,
              '&:hover': { opacity: 1 }
            }}
          />
        </Box>
      </Paper>

      {/* íšŒì›ìƒì„¸ì •ë³´ ë‹¤ì´ì–¼ë¡œê·¸ */}
      <MemberDetailDialog
        open={memberDetailDialogOpen}
        onClose={handleMemberDetailClose}
        member={selectedMemberForDetail}
        onSave={handleMemberDetailSave}
      />
    </PageContainer>
  );
};

export default TodaySettlementPage; 