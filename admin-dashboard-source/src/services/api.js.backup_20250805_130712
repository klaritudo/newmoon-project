import axios from 'axios';
import { API_CONFIG } from '../config/apiConfig';

// API ì„œë¹„ìŠ¤ í†µí•© ê´€ë¦¬
const API_BASE_URL = API_CONFIG.BASE_URL;

// API ì„œë²„ í•­ìƒ ì‚¬ìš©

/*
 * ì£¼ì˜: Vite í”„ë¡ì‹œ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.
 * vite.config.jsì— ë‹¤ìŒ ì„¤ì •ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”:
 *
 * server: {
 *   proxy: {
 *     '/api-server': {
 *       target: 'http://localhost:5xxx', // í˜„ìž¬ Vite ê°œë°œ ì„œë²„ í¬íŠ¸
 *       changeOrigin: false,
 *       rewrite: (path) => path.replace(/^\/api-server/, '')
 *     }
 *   }
 * }
 *
 * ë˜ëŠ” ì •ì  íŒŒì¼ì„ ì‚¬ìš©í•˜ë ¤ë©´ public/api-server ë””ë ‰í† ë¦¬ì— health.json íŒŒì¼ì´ ìžˆì–´ì•¼ í•©ë‹ˆë‹¤.
 */

// API ì„œë²„ ìƒíƒœ í™•ì¸ ì œê±° - í•­ìƒ API ì‚¬ìš©

// axios ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
const api = axios.create({
  baseURL: API_BASE_URL,
  headers: {
    'Content-Type': 'application/json',
  },
  // ìš”ì²­ ì‹¤íŒ¨ ì‹œ 10ì´ˆ íƒ€ìž„ì•„ì›ƒ ì„¤ì •
  timeout: 10000
});

// ìš”ì²­ ì¸í„°ì…‰í„° - í† í° ì¶”ê°€
api.interceptors.request.use(
  async (config) => {
    try {
      // API ì„œë²„ ì²´í¬ ì œê±° - í•­ìƒ API ì‚¬ìš©
      
      // ë¡œê·¸ì¸ ì—”ë“œí¬ì¸íŠ¸ëŠ” í† í°ì„ ì¶”ê°€í•˜ì§€ ì•ŠìŒ
      const isLoginEndpoint = config.url && (
        config.url.includes('/auth/login') || 
        config.url.includes('/auth/login-admin')
      );
      
      if (!isLoginEndpoint) {
        const token = localStorage.getItem('token');
        if (token) {
          config.headers.Authorization = `Bearer ${token}`;
        }
      }
      
      return config;
    } catch (error) {
      console.error('ìš”ì²­ ì¸í„°ì…‰í„° ì˜¤ë¥˜:', error);
      return Promise.reject({
        ...error,
        isApiServerDown: true,
        message: 'ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¡œì»¬ ë°ì´í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.'
      });
    }
  },
  (error) => Promise.reject(error)
);

// ì‘ë‹µ ì¸í„°ì…‰í„° - ì—ëŸ¬ ì²˜ë¦¬ ë° í† í° ê°±ì‹ 
api.interceptors.response.use(
  (response) => response,
  async (error) => {
    
    // API ì„œë²„ ë‹¤ìš´ ì—ëŸ¬ì¸ ê²½ìš° (ìš”ì²­ ì¸í„°ì…‰í„°ì—ì„œ ë°œìƒ)
    if (error.isApiServerDown) {
      return Promise.reject(error);
    }
    
    const originalRequest = error.config;
    
    // API ì„œë²„ ì—°ê²° ì‹¤íŒ¨ì¸ ê²½ìš° ê·¸ëŒ€ë¡œ ì—ëŸ¬ ì „ë‹¬
    if (error.code === 'ERR_NETWORK' || error.code === 'ECONNABORTED') {
      return Promise.reject(error);
    }
    
    // 401 ì—ëŸ¬(ì¸ì¦ ì‹¤íŒ¨)ì´ê³  í† í° ê°±ì‹  ì‹œë„ë¥¼ ì•„ì§ í•˜ì§€ ì•Šì€ ê²½ìš°
    if (error.response && error.response.status === 401 && !originalRequest._retry) {
      console.log('401 ì—ëŸ¬ ë°œìƒ. URL:', originalRequest.url);
      
      // JWT ë§Œë£Œ í™•ì¸
      const errorMessage = error.response.data?.error || error.response.data?.message || '';
      const isJwtExpired = errorMessage.toLowerCase().includes('jwt expired') || 
                          errorMessage.toLowerCase().includes('token expired');
      
      if (isJwtExpired) {
        console.log('ðŸ”’ JWT í† í° ë§Œë£Œ ê°ì§€');
      }
      
      // íŠ¹ì • API í˜¸ì¶œì€ 401 ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ë¡œê·¸ì¸ íŽ˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸í•˜ì§€ ì•ŠìŒ
      const skipAuthUrls = [
        '/settings/bank-accounts',
        '/members/', // íšŒì› ìƒì„¸ ì¡°íšŒ
        '/agent-levels', // ì—ì´ì „íŠ¸ ë ˆë²¨ ì¡°íšŒ
        '/domains', // ë„ë©”ì¸ ì¡°íšŒ (ì „ì²´ ê²½ë¡œ í¬í•¨)
        '/domain-permissions/', // ë„ë©”ì¸ ê¶Œí•œ ì¡°íšŒ
        '/username-change/', // ì•„ì´ë”” ë³€ê²½ ê²€ì¦
      ];
      
      const shouldSkipAuth = skipAuthUrls.some(url => 
        originalRequest.url && originalRequest.url.includes(url)
      );
      
      console.log('Should skip auth:', shouldSkipAuth);
      
      if (shouldSkipAuth) {
        return Promise.reject(error);
      }
      
      originalRequest._retry = true;
      
      
      try {
        // ë¦¬í”„ë ˆì‹œ í† í°ìœ¼ë¡œ ìƒˆ ì•¡ì„¸ìŠ¤ í† í° ìš”ì²­
        const refreshToken = localStorage.getItem('refreshToken');
        const currentToken = localStorage.getItem('token');
        
        
        const response = await axios.post(`${API_BASE_URL}/auth/refresh-token`, {
          refreshToken,
        }, {
          headers: {
            'Authorization': `Bearer ${currentToken}`
          }
        });
        
        
        // ìƒˆ í† í° ì €ìž¥
        const { token } = response.data;
        localStorage.setItem('token', token);
        
        // ì›ëž˜ ìš”ì²­ ìž¬ì‹œë„
        originalRequest.headers.Authorization = `Bearer ${token}`;
        return api(originalRequest);
      } catch (refreshError) {
        
        // í† í° ê°±ì‹  ì‹¤íŒ¨ ì‹œ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
        localStorage.removeItem('token');
        localStorage.removeItem('refreshToken');
        localStorage.removeItem('user');
        
        // ë¡œê·¸ì¸ íŽ˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ (React Router ì‚¬ìš©)
        // window.location.href ëŒ€ì‹  ì—ëŸ¬ë¥¼ throwí•˜ì—¬ ì»´í¬ë„ŒíŠ¸ì—ì„œ ì²˜ë¦¬í•˜ë„ë¡ í•¨
        const authError = new Error('Authentication failed');
        authError.isAuthError = true;
        return Promise.reject(authError);
      }
    }
    
    return Promise.reject(error);
  }
);

// API ì„œë¹„ìŠ¤ í•¨ìˆ˜ë“¤
const apiService = {
  // ì¸ì¦ ê´€ë ¨ API
  auth: {
    login: (credentials) => api.post('/auth/login', credentials),
    logout: () => api.post('/auth/logout'),
    refreshToken: (refreshToken) => api.post('/auth/refresh-token', { refreshToken }),
    me: () => api.get('/auth/me'),
  },
  
  // ë‹¨ê³„ ê´€ë ¨ API
  agentLevels: {
    getAll: () => api.get('/agent-levels'),
    getById: (id) => api.get(`/agent-levels/${id}`),
    create: (data) => api.post('/agent-levels', data),
    update: (id, data) => api.put(`/agent-levels/${id}`, data),
    delete: (id) => api.delete(`/agent-levels/${id}`),
    updateHierarchy: (id, hierarchyOrder) => api.put(`/agent-levels/${id}/hierarchy`, { hierarchyOrder }),
  },
  
  // ê¶Œí•œ ê´€ë ¨ API
  permissions: {
    getRoles: () => api.get('/permissions/roles'),
    getRoleById: (id) => api.get(`/permissions/roles/${id}`),
    createRole: (data) => api.post('/permissions/roles', data),
    updateRole: (id, data) => api.put(`/permissions/roles/${id}`, data),
    deleteRole: (id) => api.delete(`/permissions/roles/${id}`),
    getRolePermissions: (roleId) => api.get(`/permissions/roles/${roleId}/permissions`),
    updateRolePermissions: (roleId, permissions) => 
      api.put(`/permissions/roles/${roleId}/permissions`, { permissions }),
    
    // íšŒì›ë³„ ê¶Œí•œ ê´€ë¦¬
    getMemberPermissions: (memberId) => api.get(`/permissions/member/${memberId}`),
    updateMemberPermissions: (memberId, permissions) => 
      api.put(`/permissions/member/${memberId}`, { permissions }),
    
    // ë‹¨ê³„ë³„ ê¸°ë³¸ ê¶Œí•œ ê´€ë¦¬
    updateAgentLevelPermissions: (levelId, permissions) => 
      api.put(`/permissions/agent-level/${levelId}`, { permissions }),
  },
  
  // íšŒì› ê´€ë ¨ API
  members: {
    getAll: (params) => api.get('/members', { params }),
    getById: (id) => api.get(`/members/${id}`),
    create: (data) => api.post('/members', data),
    update: (id, data) => api.put(`/members/${id}`, data),
    delete: (id) => api.delete(`/members/${id}`),
    getChildren: (parentId) => api.get(`/members/${parentId}/children`),
    updatePermissions: (id, permissions) => api.put(`/members/${id}/permissions`, { permissions }),
    getByLevel: (levelId) => api.get(`/members/by-level/${levelId}`),
    checkUsername: (username) => api.get(`/members/check-username/${username}`),
    checkNickname: (nickname) => api.get(`/members/check-nickname/${nickname}`),
    checkReferralCode: (referralCode, memberId) => 
      api.get(`/members/check-referral-code/${referralCode}`, { params: { memberId } }),
    updateReferralCode: (id, referralCode) => 
      api.put(`/members/${id}/referral-code`, { referralCode }),
  },
  
  // ëŒ€ì‹œë³´ë“œ ê´€ë ¨ API
  dashboard: {
    getStats: (period) => api.get('/dashboard/stats', { params: { period } }),
    getChartData: (chartType, period) => 
      api.get('/dashboard/charts', { params: { chartType, period } }),
  },
  
  // ì•„ì´ë”” ë³€ê²½ ê´€ë ¨ API
  usernameChange: {
    getHistory: (params) => api.get('/username-change/history', { params }),
    getOnlineChangeableUsers: () => api.get('/username-change/online-users'),
    getChangeableUsers: (agentId, excludeUserId) => 
      api.get('/username-change/changeable-users', { params: { agentId, excludeUserId } }),
    toggleChangeEnabled: (userId, enabled) => 
      api.put(`/username-change/toggle-enabled/${userId}`, { enabled }),
    executeChange: (data) => api.post('/username-change/execute', data),
    validateChange: (userId) => api.get(`/username-change/validate/${userId}`),
  },
  
  // ì •ì‚° ê´€ë ¨ API
  settlement: {
    getTodaySettlement: () => api.get('/settlement/today'),
    getDailySettlement: (params) => api.get('/settlement/daily', { params }),
    getThirdPartySettlement: (params) => api.get('/settlement/third-party', { params }),
  },
  
  // ë¡¤ë§ê¸ˆì „í™˜ë‚´ì—­ API
  rollingHistory: {
    getAll: (params) => api.get('/rolling-history', { params }),
    convert: (data) => api.post('/rolling-history/convert', data),
  },
  
  // ë¨¸ë‹ˆì²˜ë¦¬ë‚´ì—­ API
  moneyHistory: {
    getAll: (params) => api.get('/money-history', { params }),
    create: (data) => api.post('/money-history', data),
    updateStatus: (id, data) => api.put(`/money-history/${id}/status`, data),
  },
  moneyTransfer: {
    getAll: (params) => api.get('/money-transfer', { params }),
    transfer: (data) => api.post('/money-transfer/transfer', data),
    adminTransfer: (data) => api.post('/money-transfer/admin-transfer', data, {
      timeout: 30000 // Honor API ë™ê¸°í™” ë•Œë¬¸ì— 30ì´ˆë¡œ ì¦ê°€
    }),
  },
  
  // ë² íŒ…ë‚´ì—­ API
  betting: {
    getSlotCasino: (params) => api.get('/betting/slot-casino', { params }),
    getDetail: (bettingId) => api.get(`/betting/detail/${bettingId}`),
  },

  // íŒì—… ê´€ë¦¬ API
  popups: {
    getAll: (params) => api.get('/popups', { params }),
    getById: (id) => api.get(`/popups/${id}`),
    create: (data) => api.post('/popups', data),
    update: (id, data) => api.put(`/popups/${id}`, data),
    delete: (id) => api.delete(`/popups/${id}`),
    toggle: (id) => api.post(`/popups/${id}/toggle`),
    getStats: (id) => api.get(`/popups/${id}/stats`),
    uploadImage: (formData) => api.post('/popups/upload-image', formData, {
      headers: { 'Content-Type': 'multipart/form-data' }
    }),
    deleteImage: (data) => api.delete('/popups/delete-image', { data }),
    
    // ìžë™ ë‹«ê¸° ì„¤ì • ê´€ë ¨ API
    getAutoCloseSettings: () => api.get('/popups/auto-close-settings'),
    updateAutoCloseSettings: (data) => api.put('/popups/auto-close-settings', data),
  },

  // API ìž”ì•¡
  balance: {
    get: () => api.post('/balance/getbalance'), // ê°œë³„ ì‚¬ìš©ìž ìž”ì•¡
    getAgent: () => api.get('/honor-sync/agent-info'), // ì—ì´ì „íŠ¸ ì „ì²´ ìž”ì•¡
    refresh: (userId) => api.post(`/balance/admin/refresh-balance/${userId}`),
  },

  // ê²Œìž„ ê´€ë¦¬
  games: {
    getAll: (params) => api.get('/games', { params }),
    getById: (id) => api.get(`/games/${id}`),
    create: (data) => api.post('/games', data),
    update: (id, data) => api.put(`/games/${id}`, data),
    updateStatus: (id, data) => api.put(`/games/${id}/status`, data),
    sync: (data) => api.post('/games/sync', data),
    getVendors: (params) => api.get('/games/vendors', { params }),
  },
  
  // Honor API ë™ê¸°í™”
  honorSync: {
    getSyncStatus: () => api.get('/honor-sync/sync-status'),
    syncAllMembers: () => api.post('/honor-sync/sync-all-members'),
    syncMember: (userId) => api.post(`/honor-sync/sync-member/${userId}`),
    validateGameBalance: (data) => api.post('/honor-sync/validate-game-balance', data),
    validateTransferBalance: (data) => api.post('/honor-sync/validate-transfer-balance', data),
    transferToGame: (data) => api.post('/honor-sync/transfer-to-game', data),
    withdrawFromGame: (data) => api.post('/honor-sync/withdraw-from-game', data),
  },

  // ì„¤ì • ê´€ë ¨ API
  settings: {
    // ì€í–‰ ê³„ì¢Œ ê´€ë ¨
    getBankAccounts: () => api.get('/settings/bank-accounts'),
    addBankAccount: (data) => api.post('/settings/bank-accounts', data),
    updateBankAccount: (id, data) => api.put(`/settings/bank-accounts/${id}`, data),
    deleteBankAccount: (id) => api.delete(`/settings/bank-accounts/${id}`)
  },
  
  // ì‹œìŠ¤í…œ ì„¤ì • API
  systemSettings: {
    getApiSync: () => api.get('/system-settings/api-sync'),
    setApiSyncLevel: (level) => api.post('/system-settings/api-sync/level', { level }),
    toggleMemberApiSync: (memberId, enabled) => api.post(`/system-settings/api-sync/toggle/${memberId}`, { enabled }),
    getDomainSettings: () => api.get('/system-settings/domain-settings'),
    setDomainSettingLevel: (levelId) => api.post('/system-settings/domain-settings/level', { levelId })
  },
  
  // ë§ˆìŠ¤í„° IP ê´€ë¦¬ API
  masterIp: {
    getAll: () => api.get('/master-ip'),
    add: (data) => api.post('/master-ip', data),
    toggle: (id) => api.put(`/master-ip/${id}/toggle`),
    delete: (id) => api.delete(`/master-ip/${id}`),
    getLogs: (params) => api.get('/master-ip/logs', { params })
  },

  // Honor API ë™ê¸°í™”
  honorSync: {
    transferToGame: (data) => api.post('/honor-sync/transfer-to-game', data),
    withdrawFromGame: (data) => api.post('/honor-sync/withdraw-from-game', data),
    syncStatus: () => api.get('/honor-sync/sync-status'),
    agentInfo: () => api.get('/honor-sync/agent-info')
  },

  // ë¡¤ë§ê¸ˆ ì „í™˜
  rollingTransfer: {
    transfer: (data) => api.post('/rolling-transfer/transfer', data),
    getHistory: (params) => api.get('/rolling-transfer/history', { params })
  },

  // ì—ì´ì „íŠ¸ ìš”ì²­
  agentRequests: {
    create: (data) => api.post('/agent-requests/create', data),
    getReceived: () => api.get('/agent-requests/received'),
    updateStatus: (id, data) => api.put(`/agent-requests/${id}/status`, data)
  },

  // ê³µì§€ì‚¬í•­ ê´€ë ¨ API
  notices: {
    getAll: (params) => api.get('/notices', { params }),
    getById: (id) => api.get(`/notices/${id}`),
    create: (data) => api.post('/notices', data),
    update: (id, data) => api.put(`/notices/${id}`, data),
    delete: (id) => api.delete(`/notices/${id}`),
    incrementView: (id) => api.put(`/notices/${id}/view`),
    getActiveCount: (params) => api.get('/notices/count/active', { params })
  },

  // ë¡œê·¸ ê´€ë ¨ API
  logs: {
    getAuthLogs: (params) => api.get('/logs/auth', { params }),
    getMemberChanges: (params) => api.get('/logs/member-changes', { params }),
    getSystemLogs: (params) => api.get('/logs/system', { params })
  },

  // ì§ì ‘ API í˜¸ì¶œ ë©”ì„œë“œ
  get: (url, config) => api.get(url, config),
  post: (url, data, config) => api.post(url, data, config),
  put: (url, data, config) => api.put(url, data, config),
  delete: (url, config) => api.delete(url, config),
  patch: (url, data, config) => api.patch(url, data, config)
};

export default apiService; 