# ê³ ê¸‰ ë°°í¬ ì›Œí¬í”Œë¡œìš° (ìŠ¤í…Œì´ì§•/í”„ë¡œë•ì…˜)
name: Advanced Deploy

on:
  push:
    branches: 
      - main  # í”„ë¡œë•ì…˜
      - develop  # ìŠ¤í…Œì´ì§•
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

jobs:
  # ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
  build:
    runs-on: self-hosted
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
    
    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v3
    
    - name: í™˜ê²½ ì„¤ì •
      id: set-env
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
        elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          echo "environment=production" >> $GITHUB_OUTPUT
        else
          echo "environment=staging" >> $GITHUB_OUTPUT
        fi
    
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
        cd admin-dashboard-source && npm ci
        cd ../user-page-source && npm ci
        cd ../admin-api-source && npm ci
        cd ../user-api-source && npm ci
    
    - name: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
      run: |
        echo "ğŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ì¤‘..."
        # Lint ê²€ì‚¬ (ìˆë‹¤ë©´)
        # cd admin-dashboard-source && npm run lint || true
        # cd ../user-page-source && npm run lint || true
    
    - name: ë¹Œë“œ
      run: |
        echo "ğŸ”¨ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ ì¤‘..."
        cd admin-dashboard-source && npm run build
        cd ../user-page-source && npm run build
    
    - name: ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v3
      with:
        name: build-artifacts
        path: |
          admin-dashboard-source/dist
          user-page-source/build
        retention-days: 1

  # ìŠ¤í…Œì´ì§• ë°°í¬
  deploy-staging:
    needs: build
    if: needs.build.outputs.environment == 'staging'
    runs-on: self-hosted
    environment: staging
    
    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v3
    
    - name: ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
      uses: actions/download-artifact@v3
      with:
        name: build-artifacts
    
    - name: ë°±ì—… ìƒì„±
      run: |
        echo "ğŸ’¾ ë°±ì—… ìƒì„± ì¤‘..."
        timestamp=$(date +'%Y%m%d-%H%M%S')
        mkdir -p /var/backups/deployments
        tar -czf "/var/backups/deployments/backup-staging-${timestamp}.tar.gz" \
          admin-dashboard-source/dist \
          user-page-source/build || true
    
    - name: ë°°í¬
      run: |
        echo "ğŸš€ ìŠ¤í…Œì´ì§• í™˜ê²½ì— ë°°í¬ ì¤‘..."
        # ë¹Œë“œëœ íŒŒì¼ ë³µì‚¬
        cp -r admin-dashboard-source/dist/* /var/www/staging/admin-dashboard/ || true
        cp -r user-page-source/build/* /var/www/staging/user-page/ || true
        
        # PM2 ì¬ì‹œì‘
        pm2 restart admin-api-staging user-api-staging || true
        pm2 save
    
    - name: í—¬ìŠ¤ì²´í¬
      run: |
        sleep 15
        ./scripts/health-check.sh
        echo "âœ… ìŠ¤í…Œì´ì§• ë°°í¬ ì™„ë£Œ!"

  # í”„ë¡œë•ì…˜ ë°°í¬ (í”„ë¡œë•ì…˜ ì„œë²„ ì •ë³´ í•„ìš”)
  deploy-production:
    needs: build
    if: needs.build.outputs.environment == 'production'
    runs-on: self-hosted
    environment: production
    
    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v3
    
    - name: ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
      uses: actions/download-artifact@v3
      with:
        name: build-artifacts
    
    - name: í”„ë¡œë•ì…˜ ë°°í¬ ì¤€ë¹„
      run: |
        echo "âš ï¸ í”„ë¡œë•ì…˜ ë°°í¬ ì¤€ë¹„ ì¤‘..."
        echo "í”„ë¡œë•ì…˜ ì„œë²„ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤:"
        echo "- ì„œë²„ IP: ${{ secrets.PRODUCTION_HOST || 'ì„¤ì • í•„ìš”' }}"
        echo "- ì‚¬ìš©ì: ${{ secrets.PRODUCTION_USER || 'ì„¤ì • í•„ìš”' }}"
        
        # í”„ë¡œë•ì…˜ ì„œë²„ ì •ë³´ê°€ ìˆë‹¤ë©´ SCPë¡œ ì „ì†¡
        if [[ -n "${{ secrets.PRODUCTION_HOST }}" ]]; then
          echo "ğŸ“¤ í”„ë¡œë•ì…˜ ì„œë²„ë¡œ íŒŒì¼ ì „ì†¡ ì¤‘..."
          # scp -r admin-dashboard-source/dist/* ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }}:/var/www/production/admin-dashboard/
          # scp -r user-page-source/build/* ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }}:/var/www/production/user-page/
          
          # SSHë¡œ ì›ê²© ëª…ë ¹ ì‹¤í–‰
          # ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} "pm2 restart all"
        else
          echo "âŒ í”„ë¡œë•ì…˜ ì„œë²„ ì •ë³´ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          echo "GitHub Secretsì— ë‹¤ìŒ ì •ë³´ë¥¼ ì„¤ì •í•˜ì„¸ìš”:"
          echo "- PRODUCTION_HOST"
          echo "- PRODUCTION_USER"
          echo "- PRODUCTION_SSH_KEY"
          exit 1
        fi
    
    - name: í”„ë¡œë•ì…˜ í—¬ìŠ¤ì²´í¬
      if: success()
      run: |
        echo "ğŸ¥ í”„ë¡œë•ì…˜ í—¬ìŠ¤ì²´í¬ ì¤‘..."
        # í”„ë¡œë•ì…˜ URLë¡œ í—¬ìŠ¤ì²´í¬
        # curl -f https://your-production-domain.com/health || exit 1
        echo "âœ… í”„ë¡œë•ì…˜ ë°°í¬ ì™„ë£Œ!"

  # ë¡¤ë°± (í•„ìš”ì‹œ)
  rollback:
    if: failure()
    needs: [deploy-staging, deploy-production]
    runs-on: self-hosted
    
    steps:
    - name: ë¡¤ë°± ì‹¤í–‰
      run: |
        echo "âš ï¸ ë°°í¬ ì‹¤íŒ¨. ë¡¤ë°± ì‹œì‘..."
        # ê°€ì¥ ìµœê·¼ ë°±ì—…ìœ¼ë¡œ ë³µì›
        latest_backup=$(ls -t /var/backups/deployments/backup-*.tar.gz 2>/dev/null | head -1)
        if [[ -n "$latest_backup" ]]; then
          tar -xzf "$latest_backup" -C /
          pm2 restart all
          echo "âœ… ë¡¤ë°± ì™„ë£Œ"
        else
          echo "âŒ ë¡¤ë°±í•  ë°±ì—…ì´ ì—†ìŠµë‹ˆë‹¤."
        fi